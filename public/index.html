<!DOCTYPE html>
<html>
<head>
  <title>Chat WebRTC</title>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h2>Chat Caméra</h2>
  <div id="videos"></div>
  <button id="toggle-video">Caméra</button>
  <button id="toggle-audio">Micro</button>

  <script>
    const socket = io();
    const room = 'general';
    const peers = {};
    let localStream = new MediaStream();
    let videoEnabled = false;
    let audioEnabled = false;

    async function startVideo() {
      if (!videoEnabled) {
        const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        stream.getVideoTracks().forEach(track => localStream.addTrack(track));
        addVideo(localStream, 'Moi');
        videoEnabled = true;
      } else {
        localStream.getVideoTracks().forEach(track => track.enabled = !track.enabled);
      }
    }

    async function startAudio() {
      if (!audioEnabled) {
        const stream = await navigator.mediaDevices.getUserMedia({ video:false, audio:true });
        stream.getAudioTracks().forEach(track => localStream.addTrack(track));
        audioEnabled = true;
      } else {
        localStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
      }
    }

    function addVideo(stream, id) {
      let vid = document.getElementById(id);
      if (!vid) {
        vid = document.createElement('video');
        vid.id = id;
        vid.autoplay = true;
        if(id==='Moi') vid.muted = true;
        document.getElementById('videos').appendChild(vid);
      }
      vid.srcObject = stream;
    }

    socket.emit('join', room);

    socket.on('new-user', id => {
      const pc = new RTCPeerConnection();
      peers[id] = pc;
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = e => {
        if(e.candidate) socket.emit('signal', { to:id, data:{ candidate: e.candidate } });
      };
      pc.ontrack = e => addVideo(e.streams[0], id);

      pc.createOffer().then(offer => {
        pc.setLocalDescription(offer);
        socket.emit('signal', { to:id, data:{ sdp: offer } });
      });
    });

    socket.on('signal', async ({ from, data }) => {
      let pc = peers[from];
      if(!pc) {
        pc = new RTCPeerConnection();
        peers[from] = pc;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
        pc.onicecandidate = e => { if(e.candidate) socket.emit('signal', { to:from, data:{ candidate:e.candidate } }); };
        pc.ontrack = e => addVideo(e.streams[0], from);
      }

      if(data.sdp) {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        if(data.sdp.type==='offer') {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          socket.emit('signal',{ to:from, data:{ sdp:pc.localDescription } });
        }
      } else if(data.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    });

    socket.on('user-left', id => {
      peers[id]?.close();
      delete peers[id];
      document.getElementById(id)?.remove();
    });
